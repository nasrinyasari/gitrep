---
 - name: install and start nginx
   hosts: webservers
   remote_user: ubuntu
   become: yes

   tasks:
   - name: apt-get update
     apt:
       update_cache: yes
       cache_valid_time: 3600

   - name: install nginx
     apt: 
       name: nginx 
       state: latest

   - name: install php
     apt:
       name: php
       state: latest

   - name: install php-fpm
     apt:
       name: php-fpm
       state: latest

   - name: restart nginx
     service:
       name: nginx
       state: restarted  
#############################################
 - name: install and start haproxy
   hosts: haproxy
   remote_user: ubuntu
   become: yes

   tasks:
   - name: install haproxy
     apt:
       name: haproxy
       state: latest

   - name: restart haproxy
     service:
       name: haproxy
       state: restarted
#############################################
 - name: configure nginx
   hosts: webservers
   become: true
  
   tasks:

   - name: create php file
     copy:
       src=index.php dest=/var/www/html/index.php

   - name: create default nginx vhost
     copy:
       src=default.conf dest=/etc/nginx/sites-available/default.conf

   - name: create default nginx vhost symlink
     file:
       src=/etc/nginx/sites-available/default.conf
       dest=/etc/nginx/sites-enabled/default.conf
       state=link    
     notify: restart nginx

   handlers:
   - name: restart nginx
     service:
       name=nginx
       state=restarted

